<style>
body {
    min-width:480px;
    position:relative;
    text-align: center;
    background-color: #000;
    margin-left: auto; margin-right: auto;
    font-family:sans-serif;
    margin:5px;
    padding:8px;
}

#error {
    text-align: left;
    font-weight: bold;
    font-family: sans-serif;
    font-size: 16px;
    color: white;
    padding: 10px;
    margin-left: auto; margin-right: auto;
    margin-top: 5px;
    text-shadow: #333 1px 1px 1px;
    -moz-border-radius: 4px;
    -webkit-border-radius: 4px;
    -moz-box-shadow:#666 2px 2px 2px;
    -webkit-box-shadow: #666 2px 2px 2px;
    background: #F58400 url('../images/menumask.png') repeat-x;
    border: 1px solid #FF8400;
}

#description {
    font-weight: normal;
    margin-bottom: 5px;
}

#options {
    float: right;
    position: relative;
    top: -15px;
}

.button {
	font: bold 12px Arial;
	text-decoration: none;
	background-color: #DDD;
	color: #000;
	padding: 2px 6px 2px 6px;
	border-top: 1px solid #CCC;
	border-right: 1px solid #333;
	border-bottom: 1px solid #333;
	border-left: 1px solid #CCC;
	float: right;
}

.button:hover {
	color: #333;
	border: 2px solid #666;
}


</style>
<body>
    <div id="error">
        <div id="title"></div>
        <hr/>
        <div id="description">
        </div>
    </div>
</body>
<script>
    function callDoUserLogin(response) {
        response.result['valid'] = 'override';
        code = "response = {};" +
            "response.result = {};" +
            "response.result['valid'] = 'override';" +
            "gpgAuth.serverResult(response);";
        chrome.tabs.executeScript(
            window.response.result.validation.tab.id, 
            {'code': code}
        );
    }
    
    function initiateImport(){
    	chrome.tabs.getSelected(null, function(_tab) {
            var re = /^.*?\/\/(.*?\.[^0-9]{3,4})\/.*?/gi
            domain = re.exec(_tab.url)[1]
	    	console.log(_tab.url, domain);
			chrome.extension.sendRequest({msg: 'doKeyImport', 'tab': _tab, 'domain': domain},
				function(response) {
					if (response.result.valid) {
						// display the imported key and ask for trust
						document.getElementById('description').innerHTML = "Here is a summary of the import operation - (lots of TODO's here...<br/\><br/\>" +
							response.result.msg;
							
					} else {
						document.getElementById('description').innerHTML = "Unable to retrieve the or import the public key.<br/\><br/\>";
						document.getElementById('description').innerHTML += "<pre>" + response.result.msg + "</pre>";
					}
				}
			);
	    });
    }

    chrome.tabs.getSelected(null, function(_tab) {
    	chrome.extension.sendRequest({msg: 'getPopupData', 'tab': _tab},
    		function(data_response) {
				chrome.extension.sendRequest({msg: 'getPopupError', 'tab': _tab},
					function(error_response) {
				        if (error_response.result.errorno) {
				        	window.response = data_response;
				            title = document.getElementById('title');
				            desc = document.getElementById('description');
				            title.innerHTML = error_response.result.error;
				            switch(error_response.result.errorno) {
				                case 1:
				                    desc.innerHTML = "You do not have the public key for this domain.<br/\><br/\>Click on the \"import\" button below if you would like to attempt to import it, or log in without verifying the server.<br/\><br/\><div id='options'><input type='button' value='Login without verifying' onclick='callDoUserLogin(window.response);window.close();'/\><input type='button' value='Import' onclick='initiateImport();'/\></div>";
				                    break;
				                case 2:
				                    desc.innerHTML = "In order for gpgAuth to determine the trust for this domain, you must enable at least 1 private key in the options window<br/\><br/\><div id='options'><input type='button' onclick='window.location = \"" + chrome.extension.getURL('options.html') + "?tab=1&helper=enable\";' value=\"Click here to go to the options page\"/\></div>";
				                    break;
				                case 3:
				                    desc.innerHTML = "In order to perform verification of a domain, gpgAuth must know your desired default key.<br/\><br/\><div id='options'><input type='button' onclick='window.location = \"" + chrome.extension.getURL('options.html') + "?tab=1&helper=default\"' value=\"Click here to go to the options page\"/\></div>";
				                    break;
				                case 4: // The server does not have the users reported public key
				                	desc.innerHTML = "The server was unable to find or otherwise access your PublicKey";
				                	break;
				                case 5: // Unable to decrypt token (Bad or cancelled passphrase)
				                	desc.innerHTML = "Unable to decrypt the token provided by the server;<br/\><br/\>The passphrase was incorrect or the passphrase dialog may have been cancelled.<br/\><br/\><div id='options'><input type='button' value='Retry Login' onclick='callDoUserLogin(window.response);window.close();'/\></div>";
				                	break;
				                case 6: // Token format does not match
				                	desc.innerHTML = "The token provided by the server is either empty, or it does not match the required format.";
				                	break;
				            }
				        }
			    	}
			    )
			}
		)
    });
</script>

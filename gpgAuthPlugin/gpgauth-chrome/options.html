<html>
<head>
<title>gpgAuth Chrome Options</title>
<link type="text/css" href="jquery/css/ui-darkness/jquery-ui-1.8.4.custom.css" rel="stylesheet" />
<script type="text/javascript" src="jquery/js/jquery-1.4.2.min.js"></script>
<script type="text/javascript" src="jquery/js/jquery-ui-1.8.4.custom.min.js"></script>
<script type="text/javascript" src="jquery/js/jquery.passwordStrength.js"></script>
<script type="text/javascript">
/* <![CDATA[ */
var ext = chrome.extension.getBackgroundPage();
$(function(){
    $('#enable-gpgauth-check')[0].checked = 
        (window.ext.gpgauth_prefs.gpgauth_enabled.get() == 'true');

    function buildPrivateKeylist(openKey, openUID){
        var pkeylist = JSON.parse(window.ext.plugin.getPrivateKeyList());

        if (!pkeylist) {
            // if the parsing failed, create an empty keylist
            pkeylist = {};
        }

        var keylist = JSON.parse(window.ext.plugin.getKeyList());
        if (!keylist) {
            // if the parsing failed, create an empty keylist
            keylist = {};
        }

        enabled_keys = window.ext.gpgauth_prefs.enabled_keys.get();

        private_keylist = document.getElementById('private_keylist');
        private_keylist.innerHTML += "<div class='ui-accordion-left'></div>";

        // Create the key-generate button and dialog
        genkey_div = document.createElement('div');
        genkey_div.style.padding = "8px 0 20px 0";
        genkey_button = document.createElement('input');
        genkey_button.setAttribute('value', 'Generate New Key');
        genkey_button.setAttribute('type', 'button');
        $(genkey_button).button().click(function(e){
            $("#genkey-dialog").dialog({
                "buttons": { 
                    "Create": function() {
                        form = $(this).find("#genkey-form")[0];
                        $(form).parent().before("<div id=\"genkey-status\"> </div>");
                        error = "";
                        if (!form.uid_0_name.value){
                            error += "Name Required<br>";
                            $(form.uid_0_name).addClass("input-error");
                        }
                        if (!form.uid_0_email.value){
                            error += "Email Required<br>";
                            $(form.uid_0_email).addClass("input-error");
                        }
                        if (form.passphrase.value != form.pass_repeat.value){
                            $(form.passphrase).addClass("input-error");
                            $(form.pass_repeat).addClass("input-error");
                            $(form.passphrase).next()
                                .find("#passwordStrength-text")
                                .html("Passphrases do not match")
                                .css({"color": "#f00"});
                            error += "Passphrases do not match<br>";
                        }
                        if (error.length) {
                            $("#genkey-status").html(error)[0].style.display="block";
                            return false;
                        }
                        chrome.extension.onConnect.addListener(function(port) {
                            port.onMessage.addListener(function(msg) {
                                if (msg.type == "progress") {
                                    data = msg.data;
                                    if (!isNaN(data))
                                        data = String.fromCharCode(data);
                                    data += " ";
                                    $("#genkey_progress")[0].innerHTML += data;
                                }
                            });
                        });
                        $("#genkey-form").find(".open").trigger("click");
                        console.log("going to create a key with the following details:" + '\n' +
                            "Primary Key:", form.publicKey_algo.value + 
                              ' (' + form.publicKey_size.value + ')\n' +
                            "Sub Key:", form.subKey_algo.value + 
                              ' (' + form.subKey_size.value + ')\n' +
                            "name:", form.uid_0_name.value + '\n' +
                            "comment: [Comments not supported yet; this will be blank]\n" +
                            "email:", form.uid_0_email.value + '\n' +
                            "passphrase:", form.passphrase.value +  '\n' +
                            "expiration:", "Key will expire in " + form.key_expire.value + ' days');
                        $("#genkey-dialog").dialog("option", "minHeight", 250);
                        $("#genkey-status").html(error)[0].style.display="block";
                        $("#genkey-status").html("Building key, please wait..");
                        $("#genkey-status").after("<div id='genkey-status_detail' style=\"font-size: 12px; color:#fff;padding: 20px;\">This may take a long time (5 minutes or more) to complete depending on the selected options. Please be patient while the key is created. It is safe to close this window, key generation will continue in the background.<br><br><div id='genkey_progress' style='height:auto;display:block;'></div></div>");
                        $(form)[0].style.display = 'none';
                        $("#genkey-dialog")[0].style.height = "20";
                        $("#genkey-dialog")[0].style.display = "none";
                        chrome.extension.sendRequest({msg: 'async-gpgGenKey',
                                data: {'publicKey_algo' : form.publicKey_algo.value,
                                'publicKey_size' : form.publicKey_size.value,
                                'subKey_algo' : form.subKey_algo.value,
                                'subKey_size' : form.subKey_size.value, 
                                'uid_0_name' : form.uid_0_name.value,
                                'uid_0_email' : form.uid_0_email.value, 
                                'key_expire' : form.key_expire.value,
                                'passphrase' : form.passphrase.value }
                            }, function(response) { 
                                if (response.result == "queued") {
                                    $("#genkey-dialog").dialog("option", "buttons", { 
                                        "Close": function() {
                                            $("#genkey-dialog").dialog("close");
                                        }
                                    });
                                }   
                            });
                    },
                    Cancel: function() {
                        $("#genkey-dialog").dialog("close");
                    }
                },
                "beforeClose": function () {
                    $(this).dialog("destroy");
                    $("#genkey-status_detail").remove()
                    $("#genkey-status").remove()
                    $(this).find("#genkey-form")[0].style.display="block";
                    $("#genkey-dialog").dialog({
                        resizable: false,
                        minHeight: 250,
                        width: 630,
                        modal: true,
                        autoOpen: false
                    });
                }
            });

            $("#genkey-form").children('input').removeClass('input-error');
            $("#genkey-form")[0].reset();
            $('.key-algo').each(function(){
                $(this)[0].options.selectedIndex = $(this)[0].options.length - 1;
                }).change(function(){
                    if ($(this)[0].options.selectedIndex == 0){
                        $(this).parent().next().find('.key-size')[0].options.selectedIndex = 0;
                        $(this).parent().next().find('.key-size')[0].children(1).disabled = true;
                        $(this).parent().next().find('.key-size')[0].children(2).disabled = true;
                    } else {
                        $(this).parent().next().find('.key-size')[0].children(1).disabled = false;
                        $(this).parent().next().find('.key-size')[0].children(2).disabled = false;
                        $(this).parent().next().find('.key-size')[0].options.selectedIndex = 1;
                    }
                });
            $("#genkey-dialog").dialog('open');
            $("#genkey-form").find(".open").trigger("click");
        });
        $("#genkey-dialog").dialog({
            resizable: false,
            minHeight: 250,
            width: 630,
            modal: true,
            autoOpen: false
        });
        $('.passphrase').passwordStrength("#pass_repeat");
        genkey_div.appendChild(genkey_button);
        document.getElementById('private_keylist').appendChild(genkey_div);

        $('ul.expand').each(function(){
            $('li.trigger', this).filter(':first').addClass('top').end().filter(':not(.open)').next().hide();
            $('li.trigger', this).click(function(){
                height = ($("#genkey-status")) ? $("#genkey-status").height() : 0;
                if($(this).hasClass('open')) {
                    $(this).removeClass('open').next().slideUp();
                    $("#genkey-dialog").dialog("option", "minHeight", 250 + height);
                } else {
                    $(this).parent().find('li.trigger').removeClass('open').next().filter(':visible').slideUp();
                    $(this).addClass('open').next().slideDown();
                    $("#genkey-dialog").dialog("option", "minHeight", 410 + height);
                }
            });
        });
        // End key generation dialog

        // Build keylist accordion
        var prev_key = null;
        for (key in pkeylist){
            keyobj = document.createElement('div');
            if (parseInt(keylist[key].disabled) == 1)
                keyobj.className = 'disabled';
            if (parseInt(keylist[key].expired) == 1)
                keyobj.className = 'invalid-key';
            if (parseInt(keylist[key].invalid) == 1)
                keyobj.className = 'invalid-key';
            if (parseInt(keylist[key].revoked) == 1)
                $(keyobj).addClass('invalid-key');
            keyobj.className += ' primary_key';
            enabled = (key in enabled_keys) ? " checked" : "";
            status_text = (enabled) ? "Enabled" : "Disabled";
            default_key = (key == window.ext.gpgauth_prefs.default_key.get()) ? 'checked' : '';
            keyobj.innerHTML = "<h3 class='private_keylist' style='height: 24px;'><a href='#'><span style='margin: 0;width: 50%;'>" + keylist[key].name + "&nbsp;&nbsp;-&nbsp;&nbsp;[0x" + key.substr(-8) + "]</span></a><span class='trust' style='z-index:1000; left: 12px; top:-25px;height:22px;'>" +
            "<input class='enable-check' id='check-" + key +"' type='checkbox'" + enabled + 
                " onclick=\"if ('" + key + "' == window.ext.gpgauth_prefs.default_key.get()){ $(this).next()[0].className += ' ui-state-active'; return false }; (this.checked) ? window.ext.gpgauth_prefs.enabled_keys.add('" + key + "') : window.ext.gpgauth_prefs.enabled_keys.remove('" + key + "'); (this.checked) ? $(this).button('option', 'label', 'Enabled') : $(this).button('option', 'label', 'Disabled');\"/\><label for='check-" + key + "' style='z-index:100;'>" + status_text + "</label><input class='default-check' type='radio' name='default_key' id='default-" + key + "' " + default_key + "/\><label class='default-check' style='z-index: 0; margin-left: 0px;' for='default-" + key + "'>Set as default</label>" +
                "</span></h3>";
            private_keylist.appendChild(keyobj);
            keylist[key].nuids = 0;
            for (uid in keylist[key].uids) {
                keylist[key].nuids += 1;
            }
            uidlist = document.createElement('div');
            uidlist.setAttribute('class', 'uidlist');
            uidlist.setAttribute('id', key);
            created_date = new Date(pkeylist[key].subkeys[0].created * 1000).toJSON().substring(0, 10);
            expiry = (pkeylist[key].subkeys[0].expires == 0) ? 'Never' : new Date(pkeylist[key].subkeys[0].expires * 1000).toJSON();
            if (pkeylist[key].subkeys[0].expires > 0) {
                expiry = (Math.round(new Date().getTime()/1000.0) > parseInt(pkeylist[key].subkeys[0].expires)) ? "Expired" : expiry.substring(0, 10);
            }
            uidlist.innerHTML = "<div class='keydetails'><span class='dh'>Key Details</span><hr/\>" +
                "<span><h4>KeyID:</h4> 0x" + key.substr(-8) + "</span><span><h4>Key Created:</h4> " + created_date + "</span><span><h4>Expires:</h4> " + expiry + "</span><span><h4>UIDs:</h4> " + keylist[key].nuids + "</span><br/\>" +
                "<h4>Fingerpint</h4>: " + pkeylist[key].fingerprint +
                "<br/\><br/\>" +
                "<span class='dh'>Key Options</span><hr/\>" +
                "</div>";
            for (uid in keylist[key].uids) {
                uidobj = document.createElement('div');
                uidobj.setAttribute('class', 'uid');
                uidobj.setAttribute('id', key + '-' + uid);
                if (parseInt(keylist[key].expired) == 1 || parseInt(keylist[key].uids[uid].revoked))
                    uidobj.className += ' invalid-key';
                email = (keylist[key].uids[uid].email.length > 1) ? "  -  &lt;" + keylist[key].uids[uid].email + "&gt;" :
                    "  - (no email address provided)";
                uidobj.innerHTML += "<h4 class='uidlist'><a href='#'><span style='margin:0; width: 50%'>" + keylist[key].uids[uid].uid + email + "</span><span class='trust' style='text-decoration: none;'>" + 
                keylist[key].uids[uid].validity + "</span></a></h4>";
                signed = 0;
                nd_trust = false;
                uidobjbody = document.createElement('div');
                uidobjbody.innerHTML = "<div class='uid-options'><input class='uid-option-button' id='sign-" + key + "-" + uid + "' type='button' value='Sign this UID'/\></div><br/\>";
                if (parseInt(keylist[key].uids[uid].revoked))
                    $(uidobjbody).find('.uid-option-button').addClass('uid-revoked');
                for (sig in keylist[key].uids[uid].signatures) {
                    sig_keyid = keylist[key].uids[uid].signatures[sig]
                    if (sig_keyid in keylist || nd_trust) {
                        if (sig_keyid in pkeylist) {
                            signed = 1;
                        }
                        email = (keylist[sig_keyid].uids[0].email.length > 1) ? "&lt;" + keylist[sig_keyid].uids[0].email + "&gt;" : "(no email address provided)"
                        uidobjbody.innerHTML += "<div id='sig-" + sig_keyid + "-" + sig + "' class='signature-box'>" +
                            "<img src='images/badges/stock_signature.png'><span class='signature-uid'>" + 
                            keylist[sig_keyid].name + "</span><br/\><span class='signature-email'>" + 
                            email + "</span><br/\><span class='signature-keyid'>" + sig_keyid + "</span><br/\><input type='button' class='delsig-button' id='delsig-" + key + "-" + uid + "-" + sig + "' value='Delete'/\></div>";
                    }
                }
                uidobj.appendChild(uidobjbody);
                uidlist.appendChild(uidobj);
            }
            keyobj.appendChild(uidlist);
        }
        $('#public_keylist').children('.primary_key').accordion({ header: 'h3', alwaysOpen: false,
                    autoheight:false, clearStyle:true, active: '.ui-accordion-left',
                    collapsible: true }).children();
        $('#public_keylist').children('.open_key').accordion("activate" , 0);
        $(".uidlist").children('.uid').accordion({ header: 'h4.uidlist', alwaysOpen: false,
                    autoheight:false, clearStyle:true, active:'.ui-accordion-left',
                    collapsible: true });

        if (openKey) {
            wait_icon = $('#public_keylist').children('.open_key').find('a').children('.trust')[0].children(0);
            uid_list = $('#public_keylist').children('.open_key').children('h3').find('a')[0];
            setTimeout( function() { refresh_trust(uid_list, wait_icon) }, 500);
        }
        
        $('.uidlist').find('.open_uid').accordion("activate", 0);
        $('.uid-option-button').button().click(function(e){
            params = this.id.split('-');
            console.log(params[1], 
                parseInt(params[2]) + 1,
                window.ext.gpgauth_prefs.default_key.get(), 1, 1, 1)
            sign_result = window.ext.plugin.gpgSignUID(params[1], 
                parseInt(params[2]) + 1,
                window.ext.gpgauth_prefs.default_key.get(), 1, 1, 1);
            console.log(sign_result);
            buildPublicKeylist(params[1], params[2]);
        });
        $('.uid-revoked').button({disabled: true, label: "Cannot sign revoked UID"})
        $('.delsig-button').button().click(function(e){
            params = this.id.split('-');
            calling_button = this;
            sig_details = $(calling_button).parent()[0].id.split('-');
            $("#delsig-confirm").find('#delsig-text')[0].innerHTML = "Are you certain you would like to delete signature " +
                sig_details[1] + " from this User id?";
            if (sig_details[1] in pkeylist < 1) {
                $("#delsig-confirm").find('#delsig-text')[0].innerHTML += "<br><br><span class='ui-icon ui-icon-alert' style='float:left; margin:0 7px 20px 0;'></span>This signature was made with a key that does not belong to you; This action cannot be undone without refreshing the keylist from a remote source.";
                $("#delsig-confirm").dialog("option", "height", "200");
            }
            $("#delsig-confirm").dialog("option", "buttons", { "Delete": function() {
                        delsig_result = window.ext.plugin.gpgDeleteUIDSign(params[1], parseInt(params[2]) + 1, parseInt(params[3]) + 1);
                        console.log(params[1], parseInt(params[2]) + 1, parseInt(params[3]) + 1)
                        //$(calling_button).parent().parent()[0].removeChild($(calling_button).parent()[0]);
                        buildPublicKeylist(params[1], params[2]);
                        $("#delsig-confirm").dialog("close");
                    },
                    Cancel: function() {
                        $("#delsig-confirm").dialog("close");
                    }
                }
            );
            $("#delsig-confirm").dialog('open');
        });
        $("#delsig-confirm").dialog({
            resizable: false,
            height:180,
            modal: true,
            autoOpen: false,
            buttons: {
                'Delete this Signature?': function() {
                    $(this).dialog('close');
                },
                Cancel: function() {
                    $(this).dialog('close');
                }
            }
        });
        $('#trust-level-sel').ready(function(e){
            trust_level = window.ext.gpgauth_prefs.trust_level.get();
            $(this).find('#trust-list').children().eq(trust_level).addClass('selected');
            $(this).find('#trust-level-desc').children().eq(trust_level).addClass('selected');
        });
        $('#trust-level-sel').mouseenter( function(){
            $('#trust-level-desc').slideToggle(600);
        }).mouseleave(function(){
            $('#trust-level-desc').slideToggle(600);
        });
        
        $('.level').click(function(e){
            $(this).parent().find('.selected').removeClass('selected');
            $(this).addClass('selected');
            $('#trust-level-desc').children('.selected').removeClass('selected');
            current_index = $(this).parent().find('span').index(this);
            $('#trust-level-desc').children().eq(current_index).addClass('selected');
            window.ext.gpgauth_prefs.trust_level.set(current_index);
        });
        $('.trust-level-desc').click(function(e){
            $(this).parent().find('.selected').removeClass('selected');
            $(this).addClass('selected');
            current_index = $(this).parent().find('div').index(this);
            $('#trust-list').children('.selected').removeClass('selected');
            $('#trust-list').children().eq(current_index).addClass('selected');
            window.ext.gpgauth_prefs.trust_level.set(current_index);
        });
    }

    // Begin public keylist generation
    function buildPublicKeylist(openKey, openUID){
        var pkeylist = JSON.parse(window.ext.plugin.getPrivateKeyList());
        if (!pkeylist) {
            // if the parsing failed, create an empty keylist
            pkeylist = {};
        }

        var keylist = JSON.parse(window.ext.plugin.getKeyList());
        if (!keylist) {
            // if the parsing failed, create an empty keylist
            keylist = {};
        }

        enabled_keys = window.ext.gpgauth_prefs.enabled_keys.get();
        public_keylist = document.getElementById('public_keylist');
        public_keylist.innerHTML = "<div class='ui-accordion-left'></div>";
        var prev_key = null;
        for (key in keylist){
            if (key in pkeylist) {
                continue;
            }
            status = "Valid";
            keyobj = document.createElement('div');
            if (parseInt(keylist[key].disabled) == 1) {
                $(keyobj).addClass('disabled');
                status = "Disabled";
            }
            if (parseInt(keylist[key].expired) == 1) {
                $(keyobj).addClass('invalid-key');
                status = "Expired";
            }
            if (parseInt(keylist[key].invalid) == 1) {
                $(keyobj).addClass('invalid-key');
                status = "Invalid";
            }
            if (parseInt(keylist[key].revoked) == 1) {
                $(keyobj).addClass('invalid-key');
                status = "Revoked";
            }
            $(keyobj).addClass('primary_key');
            if (key == openKey) {
                $(keyobj).addClass('open_key');
                keyobj.setAttribute('id', 'open_key');
            }
            keyobj.innerHTML = "<h3 class='public_keylist'><a href='#'><span style='margin: 0;width: 50%'>" + keylist[key].name + "</span><span class='trust'><img style='width:15px;visibility:hidden;' width='15px' src='images/wait.gif' alt='wait'></span></a></h3>";
            public_keylist.appendChild(keyobj);
            keylist[key].nuids = 0;
            for (uid in keylist[key].uids) {
                keylist[key].nuids += 1;
            }
            uidlist = document.createElement('div');
            uidlist.setAttribute('class', 'uidlist');
            uidlist.setAttribute('id', key);
            created_date = new Date(keylist[key].subkeys[0].created * 1000).toJSON().substring(0, 10);
            expiry = (keylist[key].subkeys[0].expires == 0) ? 'Never' : new Date(keylist[key].subkeys[0].expires * 1000).toJSON();
            if (keylist[key].subkeys[0].expires > 0) {
                expiry = (Math.round(new Date().getTime()/1000.0) > parseInt(keylist[key].subkeys[0].expires)) ? "Expired" : expiry.substring(0, 10);
            }
            if (parseInt(keylist[key].disabled) == 1) {
                key_option_button = "<div class='uid-options' style='font-size:12px;'><input class='key-option-button' id='enable-" + key + "' type='button' value='Enable this Key'/\></div>";
            } else {
                key_option_button = "<div class='uid-options' style='font-size:12px;'><input class='key-option-button' id='disable-" + key + "' type='button' value='Disable this Key'/\></div>";
            }
            uidlist.innerHTML = "<div class='keydetails'><span class='dh'>Key Details</span><hr/\>" +
                "<span><h4>KeyID:</h4> 0x" + key.substr(-8) + "</span><span><h4>Key Created:</h4> " + created_date + "</span><span><h4>Expires:</h4> " + expiry + "</span><span><h4>UIDs:</h4> " + keylist[key].nuids + "</span><br/\>" +
                "<h4>Fingerpint:</h4> " + keylist[key].fingerprint + "<br/\>" +
                "<h4>Status:</h4> " + status +
                "<br/\><br/\>" +
                "<span class='dh'>Key Options</span><hr/\>" +
                key_option_button + "</div>";
            for (uid in keylist[key].uids) {
                uidobj = document.createElement('div');
                uidobj.setAttribute('class', 'uid');
                uidobj.setAttribute('id', key + '-' + uid);
                if (key == openKey && uid == openUID)
                    $(uidobj).addClass('open_uid');
                if (parseInt(keylist[key].expired) == 1 || parseInt(keylist[key].uids[uid].revoked))
                    uidobj.className += ' invalid-key';
                email = (keylist[key].uids[uid].email.length > 1) ? "  -  &lt;" + keylist[key].uids[uid].email + "&gt;" :
                    "  - (no email address provided)";
                uidobj.innerHTML += "<h4 class='uidlist'><a href='#'><span style='margin:0; width: 50%'>" + keylist[key].uids[uid].uid + email + "</span><span class='trust' style='text-decoration: none;'><img style='width:15px;' src='images/wait.gif' alt='wait'/\></span></a></h4>";
                signed = 0;
                nd_trust = false;
                uidobjbody = document.createElement('div');
                uidobjbody.innerHTML = "<div class='uid-options'><input class='uid-option-button' id='sign-" + key + "-" + uid + "' type='button' value='Sign this UID'/\></div><br/\>";
                if (parseInt(keylist[key].uids[uid].revoked))
                    $(uidobjbody).find('.uid-option-button').addClass('uid-revoked');
                for (sig in keylist[key].uids[uid].signatures) {
                    sig_keyid = keylist[key].uids[uid].signatures[sig]
                    if (sig_keyid in keylist || nd_trust) {
                        if (sig_keyid in pkeylist) {
                            signed = 1;
                        }
                        email = (keylist[sig_keyid].uids[0].email.length > 1) ? "&lt;" + keylist[sig_keyid].uids[0].email + "&gt;" : "(no email address provided)"
                        uidobjbody.innerHTML += "<div id='sig-" + sig_keyid + "-" + sig + "' class='signature-box'>" +
                            "<img src='images/badges/stock_signature.png'><span class='signature-uid'>" + 
                            keylist[sig_keyid].name + "</span><br/\><span class='signature-email'>" + 
                            email + "</span><br/\><span class='signature-keyid'>" + sig_keyid + "</span><br/\><input type='button' class='delsig-button' id='delsig-" + key + "-" + uid + "-" + sig + "' value='Delete'/\></div>";
                    }
                }
                uidobj.appendChild(uidobjbody);
                uidlist.appendChild(uidobj);
            }
            keyobj.appendChild(uidlist);
        }
        $('#public_keylist').children('.primary_key').accordion({ header: 'h3', alwaysOpen: false,
                    autoheight:false, clearStyle:true, active: '.ui-accordion-left',
                    collapsible: true }).children();
        $('#public_keylist').children('.open_key').accordion("activate" , 0);
        $(".uidlist").children('.uid').accordion({ header: 'h4.uidlist', alwaysOpen: false,
                    autoheight:false, clearStyle:true, active:'.ui-accordion-left',
                    collapsible: true });

        if (openKey) {
            wait_icon = $('#public_keylist').children('.open_key').find('a').children('.trust')[0].children(0);
            uid_list = $('#public_keylist').children('.open_key').children('h3').find('a')[0];
            $("#dialog-modal").dialog({
                height: 140,
                modal: true,
                title: "Calculating Trust"
            }).children()[0].innerHTML = "Please wait while recalculate the trust for this item.";
            setTimeout( function() { refresh_trust(uid_list, wait_icon) }, 500);
        }

        $('.uidlist').find('.open_uid').accordion("activate", 0);
        $('.key-option-button').button().click(function(e){
            params = this.id.split('-');
            console.log(params[0], params[1]);
            if (params[0] == "disable")
                window.ext.plugin.gpgDisableKey(params[1]);
            else
                window.ext.plugin.gpgEnableKey(params[1]);
            buildPublicKeylist(params[1], params[2]);
        });
        $('.uid-option-button').button().click(function(e){
            params = this.id.split('-');
            console.log(params[1], 
                parseInt(params[2]) + 1,
                window.ext.gpgauth_prefs.default_key.get(), 1, 1, 1)
            sign_result = window.ext.plugin.gpgSignUID(params[1], 
                parseInt(params[2]) + 1,
                window.ext.gpgauth_prefs.default_key.get(), 1, 1, 1);
            console.log(sign_result);
            buildPublicKeylist(params[1], params[2]);
        });
        $('.uid-revoked').button({disabled: true, label: "Cannot sign revoked UID"})
        $('.delsig-button').button().click(function(e){
            params = this.id.split('-');
            calling_button = this;
            sig_details = $(calling_button).parent()[0].id.split('-');
            $("#delsig-confirm").find('#delsig-text')[0].innerHTML = "Are you certain you would like to delete signature " +
                sig_details[1] + " from this User id?";
            if (sig_details[1] in pkeylist < 1) {
                $("#delsig-confirm").find('#delsig-text')[0].innerHTML += "<br><br><span class='ui-icon ui-icon-alert' style='float:left; margin:0 7px 20px 0;'></span>This signature was made with a key that does not belong to you; This action cannot be undone without refreshing the keylist from a remote source.";
                $("#delsig-confirm").dialog("option", "height", "200");
            }
            $("#delsig-confirm").dialog("option", "buttons", { "Delete": function() {
                        delsig_result = window.ext.plugin.gpgDeleteUIDSign(params[1], parseInt(params[2]) + 1, parseInt(params[3]) + 1);
                        console.log(params[1], parseInt(params[2]) + 1, parseInt(params[3]) + 1)
                        //$(calling_button).parent().parent()[0].removeChild($(calling_button).parent()[0]);
                        buildPublicKeylist(params[1], params[2]);
                        $("#delsig-confirm").dialog("close");
                    },
                    Cancel: function() {
                        $("#delsig-confirm").dialog("close");
                    }
                }
            );
            $("#delsig-confirm").dialog('open');
        });
        $("#delsig-confirm").dialog({
            resizable: false,
            height:180,
            modal: true,
            autoOpen: false,
            buttons: {
                'Delete this Signature?': function() {
                    $(this).dialog('close');
                },
                Cancel: function() {
                    $(this).dialog('close');
                }
            }
        });
        $('.public_keylist').click(function(e){
            e.stopPropagation();
            if (this.className.search('active') > -1) {
                $("#dialog-modal").dialog({
                    height: 140,
                    modal: true,
                    title: "Calculating Trust"
                }).children()[0].innerHTML = "Please wait while recalculate the trust for this item.";
                wait_icon = $(this).children('a').children('.trust')[0].children(0)
                wait_icon.style.visibility = 'visible';
                setTimeout( function() { refresh_trust(e.target, wait_icon) }, 300);
            }
        });
    }
    /* end publickeylist */


    //buildKeylist("private");
    //buildKeylist("public");
    buildPrivateKeylist();
    buildPublicKeylist();
    



    $('#enable-gpgauth-check').button({
        'label': (window.ext.gpgauth_prefs.gpgauth_enabled.get() == 'true') ? 'Enabled' : 'Disabled'
        }).click(function(e) {
            (window.ext.gpgauth_prefs.gpgauth_enabled.get() == 'true') ? window.ext.gpgauth_prefs.gpgauth_enabled.set(false) : ext.gpgauth_prefs.gpgauth_enabled.set(true);
            status = (window.ext.gpgauth_prefs.gpgauth_enabled.get() == "true") ? 'Enabled' : 'Disabled'
            $(this).button('option', 'label', status);
            this.checked = (window.ext.gpgauth_prefs.gpgauth_enabled.get() == 'true');
            $(this).button('refresh');
        });

    refresh_trust = function(item, wait_icon) {
        if (item.parentNode.parentNode.nodeName == "H3") {
            uidcontainer = item.parentNode.parentNode.parentNode.children[1];
        } else {
            uidcontainer = item.parentNode.parentNode.children[1];
        }
        uidlist = $(uidcontainer).children('[class~=uid]');
        var pkeylist = JSON.parse(window.ext.plugin.getPrivateKeyList());
        if (!pkeylist) {
            // if the parsing failed, create an empty keylist
            pkeylist = {};
        }
        var keylist = JSON.parse(window.ext.plugin.getKeyList());
        if (!keylist) {
            // if the parsing failed, create an empty keylist
            keylist = {};
        }
        key = uidcontainer.id;
        GAUTrust = -1;
        uidlist.each(function(event, uidobj) {
            uid = uidobj.id.split('-')[1];
            for (privateKeyId in pkeylist) {
                if (!pkeylist[privateKeyId].keystatus && 
                    privateKeyId in window.ext.gpgauth_prefs.enabled_keys.get()){
                    pkey_status = 0;
                    pkey_status += parseInt(keylist[key].expired)
                    pkey_status += parseInt(keylist[key].disabled)
                    pkey_status += parseInt(keylist[key].invalid)
                    pkey_status += parseInt(keylist[key].revoked)
                    //console.log("'" + keylist[key].uids[uid].uid + "' '" + key + "' " + uid + " '" + privateKeyId + "'");
                    GAUTrust = (pkey_status || keylist[key].uids[0].signatures.length < 1) ? '?' : window.ext.plugin.verifyDomainKey(keylist[key].uids[uid].uid, key, uid, privateKeyId);
                    //console.log(keylist[key].uids[uid].uid, key, uid, privateKeyId, GAUTrust);
                    if (GAUTrust == '?' || GAUTrust == 0) {
                        break;
                    }
                }
            }
            validity = (parseInt(keylist[key].uids[uid].revoked)) ? 'revoked' : keylist[key].uids[uid].validity;
            validity += (parseInt(keylist[key].uids[uid].invalid)) ? ' | invalid' : '';
            $(uidobj).find('.trust')[0].innerHTML = validity + ' | gpgAuth trust: ' + GAUTrust;
        });
        $("#dialog-modal:ui-dialog").dialog( "destroy" );
        wait_icon.style.visibility = 'hidden';
    }
    $('#private_keylist').accordion({ header: 'h3.private_keylist', alwaysOpen: false,
                autoheight:false, clearStyle:true, active:'.ui-accordion-left',
                collapsible: true });
    if (window.location.search.substring) {
        var query_string = {};
        window.location.search.replace(
            new RegExp("([^?=&]+)(=([^&]*))?", "g"),
            function($0, $1, $2, $3) { query_string[$1] = $3; }
        );
    }
    selected_tab = query_string.tab ? query_string.tab : 0;
    $('#tabs').tabs({ selected: selected_tab });
    $('.enable-check').button().next().next().button({
            text: false,
            icons: {
                primary: 'ui-icon-check'
            }
        })
        .click(function(e) {
            keyid = this.id.substr(-16);
            window.ext.gpgauth_prefs.default_key.set(keyid);
            enable_element = $('#check-' + this.id.substr(-16))[0];
            if (keyid in window.ext.gpgauth_prefs.enabled_keys.get() == false) {
                window.ext.gpgauth_prefs.enabled_keys.add(keyid);
                $(enable_element).trigger('click');
                $(enable_element).next()[0].innerHTML = $(enable_element).next()[0].innerHTML.replace('Disabled', 'Enabled');
            }
        }).parent().buttonset();
    $('.trust').click(function(e){
        e.stopPropagation();
    });
    $('#window_functions')[0].innerHTML += "<input type='button' id='close' value='Finished'>";
    $('#close').button().click(function(e) { window.close(); });
    if (query_string.helper) {
        function bounce(elem_class, left, top, perpetual) {
            nleft = $(elem_class).parent().offset().left - left;
            ntop = $(elem_class).parent().offset().top - top;
            $("#error_help").parent().css('left', nleft).css('top', ntop).
                effect("bounce", {times: 1, direction: 'up', distance: 8 }, 1200, function(){ if (perpetual) { bounce(elem_class, left, top, perpetual) } } )
        }
        helper_arrow = document.createElement('div');
        helper_arrow.innerHTML = '' +
            '<div id="error_help" style="text-align: center; display: inline; width: 100%; text-shadow: #000 1px 1px 1px; color: #fff; font-size: 12px;">' +
            '<div id="help_text" style="display: block; -moz-border-radius: 4px; -webkit-border-radius: 4px; z-index: 10; padding: 2px 5px 2px 5px; height: 20px; margin-right: -5px; background-color: #ff6600; min-width: 130px;"></div>' +
            '<span style="margin-left: 94px;"><img width="30px" src="/images/help_arrow.png"></span>' +
            '</div>';
        helper_arrow.style.position = 'absolute';
        helper_arrow.style.zIndex = 1000;
        switch(query_string.helper){
            case 'enable':
                $(helper_arrow).find('#help_text')[0].innerHTML = "Click to enable key";
                document.body.appendChild(helper_arrow);
                $('.enable-check').click(function() { $(helper_arrow).stop(true, true).stop(true, true).hide(); });
                bounce('.enable-check', 75, 45, true);
                break;
            case 'default':
                $(helper_arrow).find('#help_text')[0].innerHTML = "Click to set default key";
                $('.default-check').click(function() { $(helper_arrow).stop(true, true).stop(true, true).hide(); });
                document.body.appendChild(helper_arrow);
                bounce('.default-check', 40, 45, true);
                break;
        }
    }
    
});
/* ]]> */
</script>
<style>
body{
    font: 62.5% "Trebuchet MS", sans-serif;
    min-width: 640px;
    margin: 4px 40px 4px 40px;
}
.ui-tabs .ui-tabs-hide {
     display: none;
}

#tabs {
    margin: auto;
}

#header-image {
    height: 74px;
    width: 74px;
    padding-right: 6px;
}

#tabs-1 {
    font-size: 14px;
}

#trust-level-sel {
    text-align: center;
    margin-left: auto; margin-right: auto;
    font-family:sans-serif;
    margin-top:5px;
    background:#fff;
    display:inline-block;
    padding:8px;
    cursor:pointer;
    -moz-border-radius: 4px;
    -webkit-border-radius: 4px;
    -moz-box-shadow:#666 2px 2px 2px;
    -webkit-box-shadow:#666 2px 2px 2px;
}

#trust-header {
    font-size: 16px;
    text-align: left;
    float:left;
    clear: right;
    color:black;
    text-shadow:#999 1px 1px 1px;
    -moz-border-radius: 8px;
    -webkit-border-radius: 8px;
}

#trust-list .selected {
  color:black !important;
  font-weight:bold;
}

#trust-list {

}

#trust-list .level {
    padding:5px;
    color:gray;
}

#trust-list .level:hover {
    font-weight:bold;
}

#trust-level-desc {
    color: #000;
    text-align: left;
    display: none;
}

.trust-level-desc {
    min-height: 30px;
    border:1px solid #ddd;
    font-family:sans-serif;
    color:white;
    padding:10px;
    text-shadow:#999 1px 1px 1px;
    -moz-border-radius: 8px;
    -webkit-border-radius: 8px;
    background: #0078a3  url('images/menumask.png') repeat-x;
    width: 600px;
}

.trust-level-desc:hover {
    background-color: #1C1;
}

#trust-level-desc .selected {
    background-color: #F58400;
}

#trust-level-desc .selected .trust-level {
    color:#000;
    text-shadow:#FFE 1px 1px 1px;
}

.trust-level {
    font-size:32px;
    padding-right: 6px;
    float:left;
}

.trust-desc {
    clear:right;
}

<!--.private_keylist {-->
<!--    width:100%;-->
<!--}-->

.invalid-key .ui-accordion-header, .disabled .ui-accordion-header {
    text-decoration: line-through;
    color: #E31;
}

.uidlist {
    padding-right: 20px;
}
.uid {
    width: 100%;
}
.trust {
    right: 0;
    float: right;
    position: relative;
    text-decoration: none;
    clear: right;
}
.keydetails {
    font-size: 14px;
    font-weight: bold;
    width: 100%;
    border: solid 1px #181;
    padding: 4px 0 4px 8px;
    margin: 2px 2px 12px -2px;
    background: #0078a3  url('images/menumask.png') repeat-x;
    text-align: left;
    color: #ffffff;
    overflow-x: hidden;
}

<!--.key-option-button {-->
<!--    font-size: 12px;-->
<!--    font-weight: normal;-->
<!--}-->
.invalid-key .keydetails, .disabled .keydetails {
    background-color: #F31;
    border: solid 1px #F11;
}
.keydetails .dh {
    color: #000;
    font-size: 14px;
}
.keydetails hr {
    margin: 0;
    right: 0;
    margin-left: 100px;
    position:relative;
    top:-10px;
    padding:0;
}
.keydetails h4 {
    color: #363636;
    margin: 0;
    display: inline;
}
.keydetails span {
    padding-right: 8px;
}
.keydetails span.ui-button-text {
    font-size: 12px;
    text-align: center;
    margin-right: 0;
}
span.trust .ui-button-text {
    padding: 4px;
    text-align: left;
    margin: 0;
    width: 50px;
    font-size: 12px;
    z-index: 800;
}
.default-check .ui-button-icon-primary{
    margin-left: 0;

}
.signature-box {
    color: #000;
    font-family:sans-serif;
    margin-top:5px;
    background:#fff;
    min-width: 240px;
    display:inline-block;
    padding:8px;
    margin-right: 20px;
    -moz-border-radius: 4px;
    -webkit-border-radius: 4px;
    -moz-box-shadow:#666 2px 2px 2px;
    -webkit-box-shadow:#666 2px 2px 2px;
}
.sign-revoked {
    background: #f8f;
}
.signature-box img {
    margin-top: 20px;
    float:left;
    height: 32px;
}
.signature-box input {
    float: right;
    position: relative;
    bottom: 0;
}
.signature-uid, .signature-email, .signature-keyid {
    font-size: 120%;
    margin-left: 10px;
    clear: both;
}
.signature-keyid {

}

.help-text {
    padding: 0 0 0 12px;
    font-size: 10px;
}

#genkey-form input[type=text], input[type=password] {
    width: 250px;
}

#genkey-status {
    padding: 2px 0 2px 12px;
    display:none;
    width: 98.2%;
    background-color: #FFAF0F;
    color: #000;
}

.input-error {
    border: 2px solid #f20;
}

ul.expand { padding:0; margin:0; list-style:none; }
ul.expand li { padding:0; margin:0; }
ul.expand li.trigger.top { margin-top:0; }
ul.expand li.trigger
{
    background:url(images/expand-collapse.gif) 0 3px no-repeat;
    cursor:pointer;
    padding:0 0 0 15px;
    margin:7px 0 0 0;
}
ul.expand li.trigger h4
{
    color:#666;
}
ul.expand li.trigger.open h4
{
    color:inherit;
}
ul.expand li.trigger.open
{
    background-position:0 -997px;
}
ul.expand ul
{
    list-style:disc inside;
    line-height:18px;
    padding:0 0 6px 10px;
}
.option ul {
    padding: 0;
    list-style: none;
}
</style>
</head>
<body>
<script src="analytics.js"></script>
<div id="header">
    <img src="images/gpgauth-128.png" id="header-image"/>
    <h1 style="display: inline; top: -18px; position: relative; text-shadow:#CCC 1px 1px 1px;">gpgAuth Options</h1>
</div>

<div id="tabs">
    <ul>
        <li><a href="#tabs-1">General</a></li>
        <li><a href="#tabs-2">Private Keys</a></li>
        <li><a href="#tabs-3">Public Keys</a></li>
    </ul>
    <div id="tabs-1">
        <span id='enable-gpgauth'><span style="text-shadow:#CCC 1px 1px 1px;">Enable gpgAuth: </span><input type='checkbox' id='enable-gpgauth-check'/><label for='enable-gpgauth-check'></label></span><br/><br/>
        <div style="width:100%; float:left;text-align: center;">
            <div id="trust-level-sel" style="min-width: 600px;">
                <span id="trust-header">
                    gpgAuth Minimum Trust Level
                </span><br/><br/>
                <div id="trust-list">
                    <span class="level"> 0 </span>
                    <span class="level"> 1 </span>
                    <span class="level"> 2 </span>
                    <span class="level"> 3 </span>
                    <span class="level"> 4 </span>
                    <span class="level"> 5 </span>
                    <span class="level"> 6 </span>
                    <span class="level"> 7 </span>
                    <span class="level"> 8 </span>
                </div>
                <div id="trust-level-desc">
                    <div class="trust-level-desc" id='trust-0'>
                        <span class="trust-level">0</span>
                        <span class="trust-desc">The UID matching the domain must be signed by one of your ultimately trusted keys (this is the most stringent/secure)</span>
                    </div>
                    <div class="trust-level-desc" id='trust-1'>
                        <span class="trust-level">1</span>
                        <span class="trust-desc">The UID matching the domain must be signed by one of your ultimately trusted keys - it is okay if that key is expired</span>
                    </div>
                    <div class="trust-level-desc" id='trust-2'>
                        <span class="trust-level">2</span>
                        <span class="trust-desc">The UID matching the domain may be signed by one of your keys that has only a Full or Marginal trust</span>
                    </div>
                    <div class="trust-level-desc" id='trust-3'>
                        <span class="trust-level">3</span>
                        <span class="trust-desc">The UID matching the domain may be signed by one of your keys that has only a Full or Marginal trust - it is okay if that key has expired</span>
                    </div>
                    <div class="trust-level-desc" id='trust-4'>
                        <span class="trust-level">4</span>
                        <span class="trust-desc">The Primary UID matching the domain may be signed by one of your ultimately trusted keys</span>
                    </div>
                    <div class="trust-level-desc" id='trust-5'>
                        <span class="trust-level">5</span>
                        <span class="trust-desc">The Primary UID matching the domain may be signed by one of your ultimately trusted keys that has expired</span>
                    </div>
                    <div class="trust-level-desc" id='trust-6'>
                        <span class="trust-level">6</span>
                        <span class="trust-desc">The Primary UID matching the domain may be signed by one of your keys that has only a Full or Marginal Trust</span>
                    </div>
                    <div class="trust-level-desc" id='trust-7'>
                        <span class="trust-level">7</span>
                        <span class="trust-desc">The Primary UID matching the domain may be signed by one of your keys that has only a Full or Marginal Trust that has expired</span>
                    </div>
                    <div class="trust-level-desc" id='trust-8'>
                        <span class="trust-level">8</span>
                        <span class="trust-desc">The Primary UID matching the domain may not be signed but otherwise meets the web of trust
                            requirements (i.e.: signed by a key that you fully trust)</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="tabs-2">
        <div id="private_keylist">
            <div class="ui-accordion-left"></div>
        </div>
    </div>
    <div id="tabs-3">
        <div id="public_keylist">
            <div class="ui-accordion-left"></div>
        </div>
    </div>
    <br/>
    <div id="window_functions" style="width:100%; text-align:right;"></div>
</div>
<div id="delsig-confirm" title="Delete this Signature?">
    <p><span class="ui-icon ui-icon-help" style="float:left; margin:0 7px 20px 0;"></span><span id='delsig-text'>Are you sure you wish to delete this signature?</span></p>
<div id="genkey-dialog" title="Key Details" style="font-size: 14px;">
    <p>
        <span id='genkey-text'>
        </span>
        <form id="genkey-form" style="width: 100%; height: 100px;">
            <label for='uid_0_name' style='display:inline-block;width:128px;'>Your Name:</label>
             <input type='text' id='uid_0_name' name='uid_0_name' onclick="$(this).removeClass('input-error');"/><span class='help-text'>i.e.: John Smith</span><br/>
            <label for='uid_0_email' style='display:inline-block;width:128px;'>Your Email:</label>
            <input type='text' id='uid_0_email' name='uid_0_email' onclick="$(this).removeClass('input-error');"/><span class='help-text'>i.e.: john.smith@example.com</span><br/>
            <label for='passphrase' style='display:inline-block;width:132px;' >Passphrase:</label><input class="passphrase" type=password name="passphrase" id="passphrase" onclick="$(this).removeClass('input-error');"/><br/>
            <label for='pass_repeat' style='display:inline-block;width:132px;'>Repeat Passphrase:</label><input class="pass_repeat" type=password name="pass_repeat" id="pass_repeat" onclick="$(this).removeClass('input-error');"/>
            <ul class="expand">
                <li class="trigger"><h4><strong>Advanced Options</strong></h4></li>
                <li>
                    <ul>
                        <li class='option'>
                            <label for='publicKey_algo'>Public Key Algorithm</label>
                            <select id='publicKey_algo' class='key-algo'>
                                <option value="DSA">DSA</option>
                                <option value="RSA" selected>RSA</option>
                            </select>
                        </li>
                        <li class='option'>
                            <label for='publicKey_size'>Public Key Size</label>
                            <select id='publicKey_size' class='key-size'>
                                <option value="1024">1024</option>
                                <option value="2048" selected>2048</option>
                                <option value="4096">4096</option>  
                            </select>
                        </li>
                        <hr>
                        <li class='option'>
                            <label for='subKey_algo'>Private Key Algorithm</label>
                            <select id='subKey_algo' class='key-algo'>
                                <option value="DSA">DSA</option>
                                <option value="ELG-E">ElGamel</option>
                                <option value="RSA" selected>RSA</option>
                            </select>
                        </li>
                        <li class='option'>
                            <label for='subKey_size'>Private Key Size</label>
                            <select id='subKey_size' class='key-size'>
                                <option value="1024">1024</option>
                                <option value="2048" selected>2048</option>
                                <option value="4096">4096</option>  
                            </select>
                        </li>
                        <hr>
                        <li class='option'>
                            <label for='expire'>Expire in </label>
                            <select id='key_expire' class='key-expire'>
                                <option value="0">Never</option>
                                <option value="30">30 Days</option>
                                <option value="90" selected>90 days</option>
                                <option value="365">1 year</option>
                            </select>
                        </li>
                    </ul>
                </li>
            </ul>
        </form>
    </p>
</div>
<div id="dialog-modal" title="">
    <div id="dialog-msg"></div>
</div>
</body>
</html>
